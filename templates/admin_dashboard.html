{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-3xl font-bold text-center mb-8 text-gray-800 dark-mode:text-white">Admin Dashboard</h2>

    <!-- TOP SECTION: CREATE NEW ELECTION -->
    <div
        class="bg-white dark-mode:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 border border-gray-100 dark-mode:border-gray-700">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800 dark-mode:text-white flex items-center gap-2">
                üó≥Ô∏è Create New Election
            </h3>
            <button onclick="toggleCreateForm()" id="toggleFormBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors font-medium text-sm">
                + New Election
            </button>
        </div>

        <div id="createElectionFormContainer" class="hidden transition-all duration-300">
            <form action="/admin" method="POST" enctype="multipart/form-data" class="space-y-6"
                onsubmit="return validateElectionTime()">
                <input type="hidden" name="action" value="create_election_with_candidates">

                <!-- Election Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-700 dark-mode:text-gray-200 border-b pb-2">Election
                            Details</h4>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark-mode:text-gray-300 mb-1">Title</label>
                            <input name="title" placeholder="e.g. Student Body President 2026" required
                                class="w-full border p-2.5 rounded-lg bg-gray-50 dark-mode:bg-gray-700 text-gray-900 dark-mode:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark-mode:text-gray-300 mb-1">Description</label>
                            <textarea name="description" rows="2" placeholder="Brief description..."
                                class="w-full border p-2.5 rounded-lg bg-gray-50 dark-mode:bg-gray-700 text-gray-900 dark-mode:text-white focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark-mode:text-gray-300 mb-1">Start
                                    Time</label>
                                <input type="datetime-local" name="start_time" id="start_time" required
                                    class="w-full border p-2.5 rounded-lg bg-gray-50 dark-mode:bg-gray-700 text-gray-900 dark-mode:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark-mode:text-gray-300 mb-1">End
                                    Time</label>
                                <input type="datetime-local" name="end_time" id="end_time" required
                                    class="w-full border p-2.5 rounded-lg bg-gray-50 dark-mode:bg-gray-700 text-gray-900 dark-mode:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <p id="dateError" class="text-red-500 text-sm hidden">‚ö†Ô∏è End date must be after start date.</p>
                    </div>

                    <!-- Candidates Section -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b pb-2">
                            <h4 class="text-lg font-semibold text-gray-700 dark-mode:text-gray-200">Candidates</h4>
                            <button type="button" onclick="addCandidateField()"
                                class="text-indigo-600 hover:text-indigo-800 dark-mode:text-indigo-400 font-medium text-sm">
                                + Add Another
                            </button>
                        </div>

                        <div id="candidatesContainer" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                            <!-- Initial Candidate Field -->
                            <div
                                class="candidate-entry bg-gray-50 dark-mode:bg-gray-700 p-4 rounded-lg border border-gray-200 dark-mode:border-gray-600 relative">
                                <span class="absolute top-2 right-2 text-xs font-bold text-gray-400">#1</span>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="candidate_name[]" placeholder="Candidate Name *" required
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                                    <input name="candidate_motto[]" placeholder="Motto / Slogan *" required
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">

                                    <input name="candidate_department[]" placeholder="Department (e.g. IT)"
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                                    <input name="candidate_year[]" placeholder="Year Level (e.g. Year 3)"
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                                </div>
                                <div class="mt-3 space-y-3">
                                    <label class="block text-sm text-gray-600 dark-mode:text-gray-400">Candidate
                                        Photo</label>
                                    <input type="file" name="candidate_photo[]" accept="image/*"
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                                    <textarea name="candidate_bio[]" rows="1" placeholder="Short Bio (Optional)"
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                                    <textarea name="candidate_manifesto[]" rows="2"
                                        placeholder="Manifesto / Key Points (Optional)"
                                        class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t border-gray-100 dark-mode:border-gray-700">
                    <button type="button" onclick="toggleCreateForm()"
                        class="mr-3 text-gray-500 hover:text-gray-700 px-4 py-2">Cancel</button>
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-transform hover:scale-105">
                        Publish Election
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ELECTIONS LIST -->
    <h3 class="text-2xl font-bold mb-4 text-gray-800 dark-mode:text-white">Existing Elections</h3>
    <div class="bg-white dark-mode:bg-gray-800 rounded-xl shadow overflow-hidden mb-12">
        <table class="w-full text-left border-collapse">
            <thead class="bg-indigo-900 text-white">
                <tr>
                    <th class="p-4 font-semibold">Title</th>
                    <th class="p-4 font-semibold">Status</th>
                    <th class="p-4 font-semibold">Timeline</th>
                    <th class="p-4 font-semibold text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark-mode:divide-gray-700">
                {% for e in elections %}
                <tr class="hover:bg-gray-50 dark-mode:hover:bg-gray-700 transition">
                    <td class="p-4">
                        <div class="font-bold text-gray-800 dark-mode:text-white">{{ e.title }}</div>
                        <div class="text-sm text-gray-500">{{ e.description }}</div>
                    </td>
                    <td class="p-4">
                        {% if e.status == 'Active' %}
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            üü¢ Active
                        </span>
                        {% elif e.status == 'Upcoming' %}
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            üîµ Upcoming
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ‚ö´ Closed
                        </span>
                        {% endif %}
                    </td>
                    <td class="p-4 text-sm text-gray-600 dark-mode:text-gray-300">
                        <div>Start: {{ e.start_time_display }}</div>
                        <div>End: &nbsp; {{ e.end_time_display }}</div>
                    </td>
                    <td class="p-4 flex justify-center gap-2">
                        <button onclick='openEditModal({{ e | tojson }})'
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition">
                            Edit
                        </button>
                        <form action="/admin" method="POST"
                            onsubmit="return confirm('Are you sure? This will delete all candidates and votes associated with this election.');">
                            <input type="hidden" name="action" value="delete_election">
                            <input type="hidden" name="election_id" value="{{ e.id }}">
                            <button type="submit"
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="p-6 text-center text-gray-500">No elections found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- EDIT ELECTION MODAL -->
    <div id="editElectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark-mode:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4 dark-mode:text-white">Edit Election</h3>
            <form action="/admin" method="POST" class="space-y-4">
                <input type="hidden" name="action" value="edit_election">
                <input type="hidden" name="election_id" id="edit_eid">

                <div>
                    <label class="block text-sm font-medium dark-mode:text-gray-300">Title</label>
                    <input name="title" id="edit_title"
                        class="w-full border p-2 rounded bg-gray-50 dark-mode:bg-gray-700 dark-mode:text-white"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium dark-mode:text-gray-300">Description</label>
                    <textarea name="description" id="edit_desc"
                        class="w-full border p-2 rounded bg-gray-50 dark-mode:bg-gray-700 dark-mode:text-white"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium dark-mode:text-gray-300">Start</label>
                        <input type="datetime-local" name="start_time" id="edit_start"
                            class="w-full border p-2 rounded bg-gray-50 dark-mode:bg-gray-700 dark-mode:text-white"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium dark-mode:text-gray-300">End</label>
                        <input type="datetime-local" name="end_time" id="edit_end"
                            class="w-full border p-2 rounded bg-gray-50 dark-mode:bg-gray-700 dark-mode:text-white"
                            required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium dark-mode:text-gray-300">Winner Message (Displayed on
                        Results Page)</label>
                    <textarea name="winner_message" id="edit_winner_message" rows="2"
                        placeholder="e.g. Hambalyo Gudoomiye Cusub!"
                        class="w-full border p-2 rounded bg-gray-50 dark-mode:bg-gray-700 dark-mode:text-white"></textarea>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="button" onclick="document.getElementById('editElectionModal').classList.add('hidden')"
                        class="mr-3 text-gray-500">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- VERIFICATION SECTION -->
    <h3 class="text-2xl font-bold mb-4 text-gray-800 dark-mode:text-white mt-12">User Verification</h3>
    <div class="bg-white dark-mode:bg-gray-800 rounded-xl shadow overflow-hidden">
        <div class="p-4 border-b border-gray-100 dark-mode:border-gray-700 flex justify-between items-center">
            <p class="text-gray-600 dark-mode:text-gray-300">
                Unverified Users: <span class="font-bold text-yellow-600">{{ unverified_count }}</span>
            </p>
            <button type="submit" form="bulkVerifyForm"
                class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded text-sm font-medium transition">
                Verify Selected
            </button>
        </div>

        <form id="bulkVerifyForm" action="/admin/bulk-verify" method="POST">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 dark-mode:bg-gray-900 text-gray-600 dark-mode:text-gray-400">
                        <tr>
                            <th class="p-3 w-10 text-center"><input type="checkbox" onclick="toggleSelectAll(this)">
                            </th>
                            <th class="p-3">Email</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark-mode:divide-gray-700">
                        {% for p in profiles %}
                        <tr class="hover:bg-gray-50 dark-mode:hover:bg-gray-700">
                            <td class="p-3 text-center">
                                <input type="checkbox" name="emails" value="{{ p.email }}" class="user-checkbox" {% if
                                    p.verified %}disabled{% endif %}>
                            </td>
                            <td class="p-3 text-sm">{{ p.email }}</td>
                            <td class="p-3 text-sm">{{ p.name }}</td>
                            <td class="p-3">
                                {% if p.verified %}
                                <span class="text-emerald-600 text-xs font-bold uppercase">Verified</span>
                                {% else %}
                                <span class="text-yellow-600 text-xs font-bold uppercase">Pending</span>
                                {% endif %}
                            </td>
                            <td class="p-3 flex gap-2">
                                {% if not p.verified %}
                                <button type="button" onclick="singleVerify('{{ p.email }}')"
                                    class="text-emerald-600 hover:underline text-xs">Verify</button>
                                {% endif %}
                                <button type="button" onclick="confirmDelete('{{ p.email }}')"
                                    class="text-red-500 hover:underline text-xs">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>

    <!-- Hidden Forms for Actions -->
    <form id="deleteForm" action="/admin/delete-user" method="POST" class="hidden">
        <input type="hidden" name="email" id="deleteEmailInput">
    </form>
    <form id="singleVerifyForm" action="/admin/bulk-verify" method="POST" class="hidden">
        <input type="hidden" name="emails" id="singleVerifyEmailInput">
    </form>

</div>

<script>
    // --- CREATE ELECTION UI ---
    function toggleCreateForm() {
        const form = document.getElementById('createElectionFormContainer');
        const btn = document.getElementById('toggleFormBtn');
        form.classList.toggle('hidden');
        btn.textContent = form.classList.contains('hidden') ? '+ New Election' : 'Close Form';
    }

    function addCandidateField() {
        const container = document.getElementById('candidatesContainer');
        const count = container.children.length + 1;
        const html = `
            <div class="candidate-entry bg-gray-50 dark-mode:bg-gray-700 p-4 rounded-lg border border-gray-200 dark-mode:border-gray-600 relative animate-fade-in-down">
                <span class="absolute top-2 right-2 text-xs font-bold text-gray-400">#${count}</span>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input name="candidate_name[]" placeholder="Candidate Name *" required
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    <input name="candidate_motto[]" placeholder="Motto / Slogan *" required
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    
                    <input name="candidate_department[]" placeholder="Department (e.g. IT)" 
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    <input name="candidate_year[]" placeholder="Year Level (e.g. Year 3)" 
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                </div>
                <div class="mt-3 space-y-3">
                    <label class="block text-sm text-gray-600 dark-mode:text-gray-400">Candidate Photo</label>
                    <input type="file" name="candidate_photo[]" accept="image/*"
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    <textarea name="candidate_bio[]" rows="1" placeholder="Short Bio (Optional)"
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                    <textarea name="candidate_manifesto[]" rows="2" placeholder="Manifesto / Key Points (Optional)"
                            class="w-full border p-2 rounded bg-white dark-mode:bg-gray-800 text-sm outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                    
                    <button type="button" onclick="this.closest('.candidate-entry').remove()" class="text-red-500 text-xs hover:underline text-left w-max">Remove Candidate</button>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- EDIT ELECTION UI ---
    function openEditModal(election) {
        document.getElementById('edit_eid').value = election.id;
        document.getElementById('edit_title').value = election.title;
        document.getElementById('edit_desc').value = election.description || '';
        document.getElementById('edit_winner_message').value = election.winner_message || '';

        const cleanISO = (str) => {
            if (!str) return '';
            return str.replace('Z', '').split('.')[0]; // remove Z and milliseconds
        };

        document.getElementById('edit_start').value = cleanISO(election.start_time);
        document.getElementById('edit_end').value = cleanISO(election.end_time);

        document.getElementById('editElectionModal').classList.remove('hidden');
        document.getElementById('editElectionModal').classList.add('flex');
    }

    // --- FORM VALIDATION ---
    function validateElectionTime() {
        const start = document.getElementById('start_time').value;
        const end = document.getElementById('end_time').value;
        if (start && end && new Date(end) <= new Date(start)) {
            document.getElementById('dateError').classList.remove('hidden');
            return false;
        }
        return true;
    }

    // --- USER ACTIONS ---
    function toggleSelectAll(source) {
        document.querySelectorAll('.user-checkbox').forEach(c => {
            if (!c.disabled) c.checked = source.checked;
        });
    }

    function singleVerify(email) {
        if (confirm('Verify ' + email + '?')) {
            document.getElementById('singleVerifyEmailInput').value = email;
            document.getElementById('singleVerifyForm').submit();
        }
    }

    function confirmDelete(email) {
        if (confirm('Delete ' + email + '?')) {
            document.getElementById('deleteEmailInput').value = email;
            document.getElementById('deleteForm').submit();
        }
    }
</script>
{% endblock %}