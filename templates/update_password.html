{% extends "base.html" %}
{% block title %}Set New Password | GSU Voting{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white dark-mode:bg-gray-800 rounded-xl shadow p-6">
  <h2 class="text-2xl font-bold mb-4 text-slate-900 dark-mode:text-white text-center">Set a new password</h2>
  <p class="text-sm text-slate-600 dark-mode:text-slate-300 mb-4 text-center">
    Enter your new password below to finish resetting your account.
  </p>

  <form id="update-password-form" class="space-y-4">
    <div>
      <label for="password" class="block text-sm font-medium text-slate-700 dark-mode:text-slate-200 mb-1">New password</label>
      <input id="password" name="password" type="password" required
             class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
    <div>
      <label for="confirm_password" class="block text-sm font-medium text-slate-700 dark-mode:text-slate-200 mb-1">Confirm new password</label>
      <input id="confirm_password" name="confirm_password" type="password" required
             class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
    <button type="submit" class="w-full py-2 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800 transition-colors">Update password</button>
    <p id="update-status" class="mt-2 text-xs text-center text-slate-500 dark-mode:text-slate-400"></p>
  </form>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  (function(){
    const form = document.getElementById('update-password-form');
    const statusEl = document.getElementById('update-status');
    const passwordEl = document.getElementById('password');
    const confirmEl = document.getElementById('confirm_password');

    if (!form) return;

    const supabaseUrl = '{{ supabase_url }}';
    const supabaseAnonKey = '{{ supabase_anon_key }}';

    if (!supabaseUrl || !supabaseAnonKey) {
      statusEl.textContent = 'Password reset is not configured correctly.';
      return;
    }

    const client = supabase.createClient(supabaseUrl, supabaseAnonKey);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';

      const password = passwordEl.value.trim();
      const confirm = confirmEl.value.trim();

      if (!password || !confirm) {
        statusEl.textContent = 'Please fill in both password fields.';
        return;
      }
      if (password !== confirm) {
        statusEl.textContent = 'Passwords do not match.';
        return;
      }

      statusEl.textContent = 'Updating password...';

      try {
        const { error } = await client.auth.updateUser({ password });
        if (error) {
          statusEl.textContent = 'Could not update password: ' + (error.message || 'Unknown error');
          return;
        }

        statusEl.textContent = 'Password updated. Redirecting to dashboard...';
        setTimeout(() => {
          window.location.href = '/';
        }, 1200);
      } catch (err) {
        statusEl.textContent = 'Unexpected error while updating password.';
      }
    });
  })();
</script>
{% endblock %}
